window.MissionModel = class extends Model
  DEFAULT_ATTRIBUTES: {center_lat: 26.214726, center_lon: -80.168894, \
    title: "New Mission", zoom: 18, is_looping: false, waypoints: []}
  VALID_TITLE = /^[a-z0-9\!\@\#\$\%\^\&\(\)\\\/\|\_\-\<\>\. ]+$/i
  VALID_ZOOM = /^([0-9]|1[0-9]|2[01])$/
  VALID_GPSCOORD = /^[\-]?[0-9]{1,3}\.[0-9]+$/

  constructor: (attributes = {}, is_persisted = false) -> 
    if attributes.hasOwnProperty 'created_at'
      attributes.created_at = new Date attributes.created_at
    else
      attributes.created_at = new Date()

    super $.extend( {}, MissionModel::DEFAULT_ATTRIBUTES, attributes), is_persisted

    @_validate 'title', (title) ->
      if ( MissionModel.find(title: title).length is 1 ) \
        and VALID_TITLE.exec(title) then true else false
    @_validate 'zoom', (zoom) ->
      if VALID_ZOOM.exec(zoom) then true else false
    @_validate 'center_lat', (center_lat) ->
      if VALID_GPSCOORD.exec(center_lat) then true else false
    @_validate 'center_lon', (center_lon) ->
      if VALID_GPSCOORD.exec(center_lon) then true else false
    @_validate 'is_looping', (is_looping) ->
      if (is_looping is true) or (is_looping is false) then true else false

  distance: -> 0

  run: ->
    console.log "TODO: Run!"

  save: ->
    @_send_command 'save_mission', @to_json()
    super
  destroy: ->
    @_send_command 'destroy_mission', @id()
    super
  _send_command: (command, params...) ->
    window.ws.send JSON.stringify( $.extend({}, window.ROBOT_MSG, \ 
      {commandid: command, command_params: params }) )

window.MissionController = class extends Controller
  MISSIONS_MSG = {requestid: 'robot_command', robotid: 'NavigatorMax', commandid: 'missions'}

  constructor:  ->
    super
    default_attrs = MissionModel::DEFAULT_ATTRIBUTES

    @map = new GpsMapView $('#mission_map')[0], default_attrs.center_lat, 
      default_attrs.center_lon, { zoom: default_attrs.zoom, is_drawing_center: false,
      tile_source: (zoom, tx, ty) -> "/images/gmap-tiles-512/#{zoom}/#{tx}-#{ty}.png" }

    @mission_edit = new MissionEditorView select_missions: $('#missions_dropdown'), \
      delete_mission: $('#delete_mission'), \
      save_mission: $('#save_mission'), \
      run_mission: $('#run_mission'), \
      form_container: $('#mission_properties')
    @waypoint_edit = new WaypointEditorView mission_view: @mission_edit, \
      map_view: @map, \
      select_waypoints: $('#waypoints_dropdown'), \
      delete_waypoint: $('#delete_waypoint'), \
      form_container: $('#waypoint_properties')

    @dash_offset = 0;

  on_connect: (ws) -> ws.send JSON.stringify MISSIONS_MSG

  on_message: (data) ->
    # We Handle this ourselves
    switch data.request.commandid
      when 'save_mission'
        @mission_edit.save_complete()
      when 'destroy_mission'
        @mission_edit.destroy_complete()
      when 'missions'
        new MissionModel attributes, true for id, attributes of data.result
        @mission_edit.missions_updated()

  render: ->
    @map.render()

    dashList = [12, 6]

    @dash_offset += 1

    @map.ctx.save()
    @map.ctx.beginPath()
    @map.ctx.setLineDash(dashList)
    @map.ctx.lineDashOffset = @dash_offset
    @map.ctx.moveTo(0,0)
    @map.ctx.lineTo(@map.ctx.canvas.width,@map.ctx.canvas.height)
    @map.ctx.lineWidth = 2.0
    @map.ctx.strokeStyle = 'ffffff'
    @map.ctx.stroke()
    @map.ctx.restore()
